<button id="pushBtn">Push to Google Sheets</button>

<script>
  let flattenedData = [];

  document.getElementById('jsonFile').addEventListener('change', function(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        let jsonData = JSON.parse(e.target.result);
        if (!Array.isArray(jsonData)) jsonData = jsonData.orders;

        flattenedData = jsonData.map(order => ({
          orderId: order.orderId,
          orderNumber: order.orderNumber,
          orderKey: order.orderKey,
          orderDate: order.orderDate,
          itemsCount: order.items.length,
          orderTotal: order.orderTotal,
          amountPaid: order.amountPaid,
          shippingCost: order.shippingAmount,
          taxAmount: order.taxAmount,
          orderStatus: order.orderStatus,
          customerId: order.customerId,
          customerEmail: order.customerEmail,
          warehouseId: order.advancedOptions.warehouseId,
          storeId: order.advancedOptions.storeId,
          carrierCode: order.carrierCode,
          shipDate: order.shipDate,
          shipCity: order.shipTo.city,
          shipState: order.shipTo.state,
          shipCountry: order.shipTo.country
        }));

        createTable(flattenedData);
      } catch (err) {
        console.error(err);
        alert('Invalid JSON file.');
      }
    };
    reader.readAsText(file);
  });

  async function pushToSheets() {
    if (!flattenedData.length) {
      alert("No data loaded.");
      return;
    }
    try {
      const res = await fetch("/push-to-sheets", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(flattenedData)
      });
      const result = await res.json();
      alert(`Pushed ${result.inserted} rows to Google Sheets`);
    } catch (err) {
      alert("Error: " + err.message);
    }
  }

  document.getElementById("pushBtn").addEventListener("click", pushToSheets);
</script>
